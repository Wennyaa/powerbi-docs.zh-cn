---
title: 优化 Microsoft Power BI Premium 容量
description: 介绍了 Power BI Premium 容量的优化策略。
author: mgblythe
ms.author: mblythe
manager: kfile
ms.reviewer: ''
ms.service: powerbi
ms.subservice: powerbi-admin
ms.topic: conceptual
ms.date: 04/09/2019
ms.custom: seodec18
LocalizationGroup: Premium
ms.openlocfilehash: 06712b6bcf57ca84ec03d2c7b99b32ea61ad8c71
ms.sourcegitcommit: 60dad5aa0d85db790553e537bf8ac34ee3289ba3
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 05/29/2019
ms.locfileid: "65565334"
---
# <a name="optimizing-premium-capacities"></a>优化高级容量

当高级容量性能问题出现时，常见的第一种方法是优化或优化你的解决方案来还原可接受的响应时间。 正在以避免购买更多高级容量，除非对齐很有必要。

当需要更多的高级容量时，有两个选项在这篇文章中所述：

- 向上扩展现有的高级容量
- 添加新的高级容量

最后，测试方法和高级容量大小调整得出结论： 这篇文章。

## <a name="best-practices"></a>最佳做法

当尝试获取最佳利用率和性能，有一些推荐的最佳实践，包括：

- 使用应用工作区而不个人工作区。
- 将业务关键和自助服务 BI (SSBI) 分成不同的容量。

  ![将业务关键和自助服务 BI 分成不同的容量](media/service-premium-capacity-optimize/separate-capacities.png)

- 如果只适用于 Power BI Pro 用户共享内容，可能无需在专用容量中存储的内容。
- 当想要实现特定的刷新时间，或需要特定功能时，请使用专用的容量。 例如，对于大型数据集或分页报表。

### <a name="addressing-common-questions"></a>解决常见的问题

优化 Power BI Premium 部署是一个复杂的主题涉及了解工作负荷要求、 可用资源和有效使用。

本文介绍了七个常见支持问题，说明可能存在的问题和说明，以及如何确定和解决这些问题的信息。

### <a name="why-is-the-capacity-slow-and-what-can-i-do"></a>为什么是很慢，容量，该怎么办？

有许多原因可以导致速度缓慢的高级容量。 此问题需要进一步信息，了解通过缓慢的含义。 将报表加载缓慢？ 或无法加载它们？ 报表视觉对象速度较慢加载或更新时用户与报表进行交互？ 将刷新花费更长时间才能完成而不是，或者以前遇到？

具有获得了原因的了解，你可以然后开始进行调查。 对以下六个问题的回答将帮助你解决的详细信息的特定问题。

### <a name="what-content-is-using-up-my-capacity"></a>哪些内容使用了我容量？

可以使用**Power BI Premium 容量指标**应用筛选器的容量，并查看性能指标的工作区内容。 就可以查看性能指标和资源使用情况的 Premium 容量中存储的所有内容在过去七天的小时。 监视通常是有关高级容量性能普遍的关注问题进行故障排除时要执行的第一步。

要监视的关键度量值包括：

- 平均 CPU 和高使用率计数。
- 平均内存利用率较高计数和特定的数据集、 数据流和分页的报表中的内存使用情况。
- 活动数据集加载到内存中。
- 平均值和最大查询持续时间。
- 平均查询等待时间。
- 平均数据集和数据流刷新时间。

在 Power BI Premium 容量度量值应用中，活动内存显示给定的报表，不能被逐出，因为它已在过去三分钟内使用的内存总量。 高出现刷新等待时间可能与大型和/或活动的数据集相关。

**的平均持续时间的前 5 个**图表突出显示前五个数据集、 分页的报表中，并使用容量资源的数据流。 内容中前五个列表是适合进行调查和可能的优化。

### <a name="why-are-reports-slow"></a>为什么是报告缓慢？

下表显示可能存在的问题以及如何处理标识和处理它们。

#### <a name="insufficient-capacity-resources"></a>没有足够的容量资源

| 查看可能的原因 | 如何识别 | 如何解决 |
| --- | --- | --- |
| 高总活动内存 （因为它是在过去三分钟内使用，不能逐出模型）。<br><br> 在查询中的多个高峰值等待时间。<br><br> 在刷新中的多个高峰值等待时间。 | 监视内存指标\[ [1](#endnote-1)\]，并将其移出计数\[ [2](#endnote-2)\]。 | 减少模型规模如何，或将转换为 DirectQuery 模式下。 请参阅[优化模型](#optimizing-models)这篇文章中的部分。<br><br> 增加容量。<br><br> 将内容分配到不同的容量。 |

#### <a name="inefficient-report-designs"></a>效率低下的报表设计

| 查看可能的原因 | 如何识别 | 如何解决 |
| --- | --- | --- |
| 报表页包含太多个视觉对象 （交互式筛选可以触发每个视觉对象至少一个查询）。<br><br> 视觉对象中检索不必要的数据。 | 查看的报表设计。<br><br> 面试报表用户都了解它们如何与报表进行交互。<br><br> 监视数据集查询指标\[ [3](#endnote-3)\]。 | 与每页更少的视觉对象的重新设计报表。 |

#### <a name="dataset-is-slow-especially-when-reports-have-previously-performed-well"></a>数据集较慢，尤其是在报表执行过良好

| 查看可能的原因 | 如何识别 | 如何解决 |
| --- | --- | --- |
| 越来越多地大容量导入数据。<br><br> 复杂或低效的计算逻辑，包括 RLS 角色。<br><br> 未完全优化模型。<br><br> (DQ/LC)网关的滞后时间。<br><br> DQ 源查询响应时间较慢。 | 查看模型设计。<br><br> 监视网关性能计数器。 | 请参阅[优化模型](#optimizing-models)这篇文章中的部分。 |

#### <a name="high-concurrent-report-usage"></a>高并发报告使用情况

| 查看可能的原因 | 如何识别 | 如何解决 |
| --- | --- | --- |
| 较高的查询等待时间。<br><br> CPU 饱和所致。<br><br> 超出 DQ/LC 连接限制。 | 监视 CPU 使用率\[ [4](#endnote-4)\]，查询等待时间和 DQ/LC 利用率\[ [5](#endnote-5) \]指标 + 查询持续时间。 如果波动，可以指示并发问题。 | 增加容量，或将内容分配到不同的容量。<br><br> 与每页更少的视觉对象的重新设计报表。 |

**说明：**    
<a name="endnote-1"></a>\[1\]平均内存使用量 (GB) 和最高内存消耗 (GB)。   
<a name="endnote-2"></a>\[2\]数据集逐出。   
<a name="endnote-3"></a>\[3\]数据集查询数据集在数据集平均查询持续时间 （毫秒），等待计数和数据集的平均等待时间 （毫秒）。   
<a name="endnote-4"></a>\[4\] CPU 高使用率计数和最高利用率 （过去 7 天） 的 CPU 时间。   
<a name="endnote-5"></a>\[5\] DQ/LC 高使用率计数和 DQ/LC 时间的最高利用率 （过去 7 天）。   

### <a name="why-are-reports-not-loading"></a>为什么是报表不加载？

报表将无法加载，时，确保登录没有足够的内存容量，以及是过度激烈。 当所有加载的模型正在主动查询，因此不能被逐出，并且任何刷新操作已暂停或延迟，这会发生。 Power BI 服务将尝试将数据集加载为 30 秒，并且使用一项建议，若要稍后重试失败的适当地通知用户。

目前没有任何要监视加载失败的报表的指标。 可以通过监视系统内存，特别是最高利用率和利用率最高的时间来确定此问题的可能性。 高数据集逐出和长时间的数据集刷新平均等待时间可能表明发生了此问题。

如果只有很少发生这种情况，这可能会不被视为优先级问题。 报表用户被通知服务正忙，并且它们应该试一段时间之后。 如果过于频繁地发生这种情况，通过扩展高级容量或通过将内容分配给不同的容量可以解决此问题。

容量管理员 （和 Power BI 服务管理员） 可以监视**查询失败**度量值以确定当发生这种情况。 它们还可以重新启动的容量，重置所有操作发生时系统超载。

### <a name="why-are-refreshes-not-starting-on-schedule"></a>为什么刷新不开始按计划？

计划的刷新开始时间不能保证。 前面曾提到，在 Power BI 服务将始终优先交互操作于后台操作。 刷新是在后台操作时满足两个条件时可能发生的：

- 没有足够的内存
- 未超过 Premium 容量支持并发刷新数

当不满足条件时，刷新会排队，直到条件较好。

对于完整的刷新，回想一下，至少双倍的当前数据集的内存大小是必需的。 如果没有足够内存可用，然后刷新不能开始直到模型逐出释放内存-这意味着延迟，直到一个或多个数据集变为非活动状态并被逐出。

回想一下，支持的最大并发刷新数设置为 1.5 倍后端虚拟核心，向上舍入。

当它不能开始下一步计划的刷新应开始之前，计划的刷新将失败。 从 UI 手动触发按需刷新将尝试在故障前运行最多三次。

容量管理员 （和 Power BI 服务管理员） 可以监视**平均刷新等待时间 （分钟）** 指标来确定计划的时间与操作的开始之间的平均延迟。

虽然通常不管理优先级，若要影响的实时数据刷新，确保有足够的内存可用。 这可能涉及隔离数据集添加到已知足够的资源容量。 还有可能与数据集所有者能够帮助错开或减少计划的数据刷新时间，以最大程度减少冲突无法协调管理员。 请注意不能查看刷新队列，或检索数据集计划管理员。

### <a name="why-are-refreshes-slow"></a>为什么不是刷新速度缓慢？

刷新可以佳或感知速度缓慢 （作为上一个常见的问题地址）。

事实上慢速刷新时，可能会由于多种原因引起：

- 资源不足的 CPU （刷新可以是大量占用 CPU 的）。
- 内存不足，导致刷新暂停 （它需要刷新以重新有利以 recommence 条件时开始）。
- 非容量原因，包括数据源系统的响应能力、 网络延迟、 无效的权限或网关的吞吐量。
- 数据卷-一个充分的理由，若要配置增量刷新，请按如下所述。

容量管理员 （和 Power BI 服务管理员） 可以监视**平均刷新持续时间 （分钟）** 度量值以确定随着时间推移，比较的基准和**平均刷新等待时间 （分钟）** 要确定之间的平均延迟的度量值的平均计划的时间与操作的开始之间的延迟。

增量刷新可显著减少数据刷新的持续时间，尤其是对于大型模型表。 有个增量刷新的四个好处：

- **刷新的速度要快**-表的一个子集需要加载、 减少 CPU 和内存使用情况，并刷新多个分区时可以获得更大的并行度。
- **仅在需要时，会发生刷新**-可以将增量刷新策略配置为加载仅当数据更改。
- **刷新会更可靠**-较短运行连接到易失性数据源系统是更不易遭受断开连接。
- **模型保持剪裁**-可以将增量刷新策略配置为自动删除历史记录超出滑动窗口的时间。

若要了解详细信息，请参阅[增量刷新 Power BI Premium 中](service-premium-incremental-refresh.md)。

### <a name="why-are-data-refreshes-not-completing"></a>为什么是数据刷新不完成？

当数据刷新开始，但无法完成时，它可以是由于多种原因引起：

- 内存不足，即使在高级容量中，只有一个模型的模型大小即非常大。
- 非容量原因，包括数据源系统断开连接、 无效的权限或网关错误。

容量管理员 （和 Power BI 服务管理员） 可以监视**刷新失败由于内存不足**指标。

## <a name="optimizing-models"></a>优化模型

最佳模型设计对提供高效、 可缩放解决方案至关重要。 但是，它超出了本文提供的完整讨论的范围。 相反，本部分将在优化模型时要考虑中提供关键领域。

### <a name="optimizing-power-bi-hosted-models"></a>优化 Power BI 托管模型

优化模型托管在高级容量可实现的数据和模型层。

请考虑导入模型优化可能性：

![导入模型的优化可能性](media/service-premium-capacity-optimize/import-model-optimizations.png)

在数据源层中：

- 关系数据源可以进行优化，以便确保最快可以刷新由预先集成的数据，应用适当的索引、 表分区，分别对应于定义的增量刷新周期和具体化计算 （来代替计算模型的表和列） 或将计算逻辑添加到视图。
- 非关系数据源可以通过使用关系存储区中预先集成。
- 请确保网关有足够的资源，最好是在具有足够的网络带宽和较近的数据源中的专用计算机上。

在模型层：

- Power Query 查询的设计可以尽量减少或消除复杂的转换，尤其是那些以合并不同的数据源 （数据仓库实现此目的在其提取-转换-加载阶段）。 此外，确保该相应数据源隐私级别设置，这可以避免需要 Power BI 加载完整的结果来生成所有查询的组合的结果。
- 模型结构确定要加载的数据，以及对模型大小直接影响。 它可以用于避免加载不必要的数据，通过删除列，删除行 （尤其是历史数据） 或通过加载 （但代价是正在加载详细的数据） 汇总的数据。 可以通过删除较大基数列 （尤其是文本列） 不存储或压缩非常高效地实现显著的大小缩减。
- 通过配置单向关系，除非有充足的理由允许双向筛选可以提高模型查询性能。 也可以考虑使用[CROSSFILTER](https://docs.microsoft.com/dax/crossfilter-function)函数而不是双向筛选。
- 聚合表可实现快速查询响应通过加载预汇总数据，但这会在较长的刷新时间增加的模型和结果的大小。 通常情况下，应为非常大的模型或复合模型设计保留聚合表。
- 计算的表和列模型大小增加，并会导致更长的刷新时间。 通常情况下，更小存储大小和速度更快的刷新时间可实现具体化或计算的数据源中数据时。 如果无法做到这一点，使用 Power Query 自定义列可以提供改进的存储压缩。
- 可能有机会来优化用于度量值和 RLS 规则，可能重写逻辑，以避免成本高昂的公式的 DAX 表达式
- 增量刷新可以极大地缩短刷新时间和节省内存和 CPU。 增量刷新还可以配置为删除历史数据保留模型大小剪裁。
- 无法为这两个模型重新设计了一个模型，有不同的域和冲突的查询模式时。 例如，某些报表存在高级基于聚合所有历史记录，并且可以容忍 24 小时的延迟。 其他报表关心的当天的数据，需要对各个事务进行细致访问。 而不是设计一个单一的模型来满足所有的报表，创建两个模型针对每个需求进行了优化。

请考虑优化了这样一些可能性 DirectQuery 模型。 当模型到基础数据源发出查询请求，数据源优化时提供响应模型查询。

 ![针对 DirectQuery 模型优化可能性](media/service-premium-capacity-optimize/direct-query-model-optimizations.png)

在数据源层中：

- 数据源可以进行优化以确保最快可以查询由预先集成的数据 （这是不可能在模型层），应用适当的索引，定义表分区，具体化汇总数据 （与索引视图） 和最小化计算的量。 传递查询需要仅筛选并执行索引的表或视图之间的内部联接时，才能够达到最佳的体验。
- 请确保网关有足够的资源，最好是在具有足够的网络带宽和较近的数据源中的专用计算机上。

在模型层：

- Power Query 查询设计最好是应该应用无需进行转换-否则尝试保持转换到绝对最小。
- 通过配置单向关系，除非有充足的理由允许双向筛选可以提高模型查询性能。 此外，模型关系应配置为采用强制引用完整性 （在这种情况下），将导致使用更高效的内部联接 （而不外部联接） 的数据源查询。
- 避免创建 Power Query 查询自定义列或模型计算的列-具体化这些中的数据源，在可能的情况。
- 可能有机会来优化用于度量值和 RLS 规则，可能重写逻辑，以避免成本高昂的公式的 DAX 表达式。

请考虑优化了这样一些可能性复合模型。 回想一下复合模型使多个导入和 DirectQuery 的表。

![优化可能性的复合模型](media/service-premium-capacity-optimize/composite-model-optimizations.png)

- 通常情况下，导入和 DirectQuery 模型优化适用于使用这些存储模式的复合模型表。
- 通常情况下，致力于通过配置 （用于表示业务实体） 的维度类型表实现均衡的设计为双存储模式和事实类型表 （通常是大型表，表示操作的事实数据） 作为 DirectQuery 存储模式。 双存储模式意味着同时导入和 DirectQuery 存储模式，这样 Power BI 服务，以确定最高效的存储模式，以生成以启用传递本机查询时使用。
- 请确保网关有足够的资源，最好是在具有足够的网络带宽和较近的数据源中的专用计算机上
- 聚合表配置为导入存储模式可以提供显著的查询性能增强功能时用于汇总 DirectQuery 存储模式事实类型表。 在这种情况下，聚合表将提高模型的大小以及刷新时间，并通常是实现更快速查询接受之列。

### <a name="optimizing-externally-hosted-models"></a>优化外部托管模型

中所述的许多优化可能性[优化 Power BI 托管模型](#optimizing-power-bi-hosted-models)部分也适用于使用 Azure Analysis Services 和 SQL Server Analysis Services 开发模型。 清除异常某些功能是它们当前不支持，包括复合模型和聚合表。

进行外部托管的数据集的其他考虑因素是相对于 Power BI 服务中托管的数据库。 对于 Azure Analysis Services，这意味着在 Power BI 租户 （主区域） 所在的同一区域中创建的 Azure 资源。 对于 SQL Server Analysis Services，iaas，这意味着托管在同一区域中，VM 并对于在本地，这意味着确保有效的网关安装程序。

另外，可能会以请注意，Azure Analysis Services 数据库和 SQL Server Analysis Services 表格数据库需要其模型完全加载到内存，以支持查询它们保持有根本倍感兴趣。 类似于 Power BI 服务中，需要有足够的内存来刷新如果在刷新过程模型必须保持联机状态。 不同于 Power BI 服务中，没有概念模型将自动过期入和移出内存根据使用情况。 Power BI Premium，因此，提供了更有效的方法来最大程度地使用较低的内存使用情况查询模型。

## <a name="capacity-planning"></a>容量规划

高级容量的大小确定其可用内存和处理器资源和容量限制。 高级容量数也是一个考虑因素，以创建多个高级容量可帮助将工作负荷相互隔离。 请注意，存储 100 TB 是每个容量节点，这很可能是多个足以满足任何工作负荷。

确定的大小和数量的高级容量极具挑战性，尤其是对于你创建的初始容量。 第一步是了解表示的平均工作负荷容量大小调整时预期日常使用情况。 请务必了解并非所有工作负荷相等。 例如-某一端的一系列的 100 个并发用户访问包含单个视觉对象的单个报表页是能轻松地实现。 -在极端情况下的另一端 100 个并发用户访问 100 个不同的报表，每个都有 100 视觉对象在报表页上，将让容量资源的非常不同的需求。

因此，容量管理员将需要考虑许多因素特定于环境、 内容和预期使用情况。 重写的目的是以最大化容量利用率，同时还提供了一致的查询时间、 可接受的等待时间和驱逐率。 要考虑的因素可能包括：

- **模型大小和数据特征**-导入模型必须是完全加载到内存中才能允许查询或刷新。 LC/DQ 数据集可能需要占用大量处理器时间和可能是大量的内存来评估复杂的度量值或 RLS 规则。 内存和处理器大小以及 LC/DQ 查询吞吐量受容量大小。
- **并发活动模型**的并发查询的不同导入模型将它提供最佳响应能力和性能，当它们保留在内存中。 应该有足够的内存来承载所有主要查询的模型，使用额外的内存来允许为其刷新。
- **导入模型刷新**-刷新类型 （完整或增量）、 持续时间和 Power Query 查询和计算的表/列逻辑的复杂性可能会影响内存和尤其是处理器使用情况。 并发刷新受容量大小 （1.5 x backend 虚拟核心，向上舍入）。
- **并发查询**-多个并发查询可产生在无响应报告时处理器或 LC/DQ 连接超出了容量限制。 这是包含多个视觉对象的报表页的情况尤其如此。
- **数据流和分页报表**-容量可以配置为支持数据流和分页的报表中，与每个需要可配置的最大容量内存百分比。 内存动态分配到数据流，但以静态方式分配给分页报表。

除了这些因素，容量管理员可以考虑创建多个容量。 多个容量允许的工作负荷隔离，可以配置，以确保优先级的工作负荷具有有保证的资源。 例如，可以创建两个容量与自助服务 BI (SSBI) 工作负荷分离业务关键型工作负荷。 业务关键的容量可以用于隔离大型公司的模型并为他们提供有保证的资源，其创作仅向 IT 部门授予访问权限。 可以使用 SSBI 容量来承载越来越多的较小的模型，与业务分析人员授予访问权限。 SSBI 容量有时可能会遇到可承受的查询或刷新等待。

随着时间推移，容量管理员可以平衡工作区之间的容量由工作区或容量，之间的工作区之间移动的内容和扩展或缩减容量。 通常情况下，与主机更大模型您向上扩展和更高的并发，横向扩展。

回想一下，购买许可证的租户提供的 v 核心。 购买**P3**订阅可用于创建一个，或达四个高级容量，即 1 个 P3，或 P2，x 2 或 4 x P1。 此外之前扩大到 P3 容量 P2 容量，可以考虑将拆分 v 核心用于创建两个 P1 容量。

## <a name="testing-approaches"></a>测试方法

一旦决定容量大小，则可以通过创建在受控的环境执行测试。 今天这样切实可行且经济的选项是创建的 Azure (Sku) 容量，注意的是 P1 容量大小相同的 A4 容量，采用 P2 和 P3 容量 A5 和 A6 容量的大小相同分别。 Azure 容量可以快速创建，并按小时计费。 因此，测试完成后，它们可以轻松地删除以停止产生成本。

测试内容可以添加到创建的 Azure 容量的工作区，然后为单个用户可以运行报表来生成查询的实际和代表性工作负荷。 如果导入模型，也应执行针对每个模型的刷新。 监视工具然后可用来查看所有指标了解资源利用率。

务必测试可重复。 应多次运行测试和他们应每次提供大约相同的结果。 这些结果的平均值可用于进行推断并估计 true 生产条件下的工作负荷。

若要生成压力测试，请考虑开发负载测试应用程序能够模拟实际工作负荷。 如何实现此目的的具体情况不在本文的讨论范围。 有关包括示例代码的详细信息，请参阅[Visual Studio 负载测试使用负载测试 Power BI 应用程序](https://blogs.msdn.microsoft.com/charles_sterling/2018/04/04/webinar-load-testing-power-bi-applications-with-visual-studio-load-test/)网络研讨会。

## <a name="acknowledgements"></a>确认

撰写本文时由 Peter Myers、 数据平台 MVP 和独立 BI 专家[位解决方案](https://www.bitwisesolutions.com.au/)。

## <a name="next-steps"></a>后续步骤

> [!div class="nextstepaction"]
> [Premium 容量方案](service-premium-capacity-scenarios.md)   
  
更多问题？ [尝试咨询 Power BI 社区](https://community.powerbi.com/)

||||||